<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Count</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f8f9fa;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --border-color: #e2e8f0;
            --accent-primary: #667eea;
            --accent-hover: #5568d3;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --bg-tertiary: #374151;
            --text-primary: #f7fafc;
            --text-secondary: #cbd5e0;
            --border-color: #4a5568;
            --accent-primary: #667eea;
            --accent-hover: #5568d3;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            font-size: 14px;
            color: var(--text-primary);
            transition: background 0.3s, color 0.3s;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            min-height: 100vh;
        }

        .header {
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 20px 40px;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-logo-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .app-logo {
            color: var(--accent-primary);
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 1.6em;
            margin-bottom: 4px;
            font-weight: 700;
        }

        .header p {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .theme-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            background: var(--border-color);
            transform: scale(1.05);
        }

        .content {
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .btn {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn i {
            font-size: 0.95em;
        }

        .btn:hover {
            background: var(--accent-hover);
            box-shadow: var(--shadow-md);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-small {
            padding: 6px 14px;
            font-size: 0.8em;
        }

        .counts-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .count-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            transition: all 0.2s;
        }

        .count-card:hover {
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .count-card h3 {
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .count-card p {
            color: var(--text-secondary);
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .count-card p i {
            color: var(--accent-primary);
            width: 16px;
            text-align: center;
        }

        .count-card h3 {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .count-card h3 i {
            color: var(--accent-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9em;
        }

        .form-group input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9em;
            transition: all 0.2s;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .form-group input[type="text"]:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .file-upload {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-tertiary);
        }

        .file-upload:hover {
            background: var(--bg-secondary);
            border-color: var(--accent-primary);
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .file-upload p {
            color: var(--text-primary);
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: var(--bg-secondary);
        }

        .items-table th {
            background: var(--bg-tertiary);
            padding: 10px;
            text-align: left;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            font-size: 0.85em;
            color: var(--text-primary);
        }

        .items-table td {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85em;
            color: var(--text-primary);
        }

        .items-table tr:hover {
            background: var(--bg-tertiary);
        }

        .items-table tr.completed {
            opacity: 0.5;
        }

        .items-table tr.completed:hover {
            opacity: 0.6;
        }

        .counter-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .counter-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: var(--accent-primary);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            line-height: 1;
            transition: all 0.2s;
        }

        .counter-btn:hover {
            background: var(--accent-hover);
        }

        .counter-btn:disabled {
            background: var(--border-color);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .counter-btn:disabled:hover {
            background: var(--border-color);
            transform: none;
        }

        .counter-value {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
            font-size: 0.95em;
        }

        .back-btn {
            margin-bottom: 20px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state h2 {
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .empty-state p {
            font-size: 0.9em;
        }

        h2 {
            font-size: 1.4em;
            color: var(--text-primary);
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9em;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
        }

        .filter-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .filter-checkbox label {
            font-size: 0.85em;
            color: var(--text-primary);
            cursor: pointer;
            user-select: none;
        }

        .table-wrapper {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-secondary);
        }

        .stats {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px 10px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-icon {
            font-size: 1.5em;
            color: var(--accent-primary);
            margin-bottom: 8px;
            display: block;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--text-primary);
            line-height: 1;
        }

        .stat-label {
            color: var(--text-secondary);
            margin-top: 8px;
            font-size: 0.75em;
            font-weight: 500;
        }

        .count-card-actions {
            margin-top: 15px;
            display: flex;
            gap: 8px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .count-card-actions .btn {
            flex: 1;
        }

        .table-actions {
            text-align: center;
            white-space: nowrap;
        }

        .table-actions-header {
            text-align: center;
            width: 120px;
        }

        .table-actions .btn {
            margin: 0 3px;
        }

        .items-accordion {
            display: none;
        }

        .accordion-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .accordion-item.completed {
            opacity: 0.5;
        }

        .accordion-header {
            padding: 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-tertiary);
            transition: background 0.2s;
        }

        .accordion-header:active {
            background: var(--border-color);
        }

        .accordion-title {
            flex: 1;
        }

        .accordion-posid {
            font-weight: 600;
            color: var(--accent-primary);
            font-size: 0.85em;
            margin-bottom: 2px;
        }

        .accordion-itemname {
            color: var(--text-primary);
            font-size: 0.8em;
        }

        .accordion-indicator {
            color: var(--text-secondary);
            font-size: 1.2em;
            transition: transform 0.2s;
        }

        .accordion-item.active .accordion-indicator {
            transform: rotate(180deg);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .accordion-item.active .accordion-content {
            max-height: 300px;
        }

        .accordion-controls {
            padding: 15px;
            background: var(--bg-secondary);
        }

        .control-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .control-row:last-child {
            border-bottom: none;
        }

        .control-label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.85em;
        }

        .checkbox-cell {
            width: 60px;
            text-align: center;
        }

        .checkbox-cell input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .completed-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .completed-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .completed-checkbox label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.85em;
            cursor: pointer;
            margin: 0;
        }

        .completed-checkbox {
            border-bottom: 1px solid var(--border-color);
        }

        @media (max-width: 767px) {
            body {
                padding: 0;
            }

            .header {
                padding: 15px 20px;
            }

            .header h1 {
                font-size: 1.3em;
            }

            .content {
                padding: 20px 15px;
            }

            .table-wrapper {
                display: none;
            }

            .items-accordion {
                display: block;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .stat-item {
                padding: 12px 8px;
            }

            .stat-icon {
                font-size: 1.2em;
                margin-bottom: 6px;
            }

            .stat-value {
                font-size: 1.4em;
            }

            .stat-label {
                font-size: 0.7em;
            }

            .counter-btn {
                width: 32px;
                height: 32px;
                font-size: 1.1em;
            }

            .storage-indicator {
                margin-top: 20px;
                padding: 15px;
            }

            .donut {
                width: 100px;
                height: 100px;
            }

            .donut-hole {
                width: 65px;
                height: 65px;
            }

            .donut-percent {
                font-size: 1.2em;
            }

            .storage-details {
                flex-direction: column;
                gap: 10px;
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 1.2em;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .modal-header p {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1.1em;
            margin-bottom: 20px;
            text-align: center;
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-buttons .btn {
            flex: 1;
        }

        .counter-btn-custom {
            min-width: 36px;
            height: 28px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75em;
            line-height: 1;
            transition: all 0.2s;
            padding: 0 6px;
        }

        .counter-btn-custom:hover {
            background: var(--border-color);
        }

        .counter-btn-custom:disabled {
            background: var(--bg-tertiary);
            cursor: not-allowed;
            opacity: 0.4;
        }

        .counter-btn-custom:disabled:hover {
            background: var(--bg-tertiary);
        }

        .history-modal-content {
            max-width: 500px;
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .history-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-item:hover {
            background: var(--bg-secondary);
            border-color: var(--accent-primary);
            transform: translateX(4px);
        }

        .history-time {
            font-weight: 600;
            color: var(--accent-primary);
            margin-bottom: 6px;
            font-size: 0.9em;
        }

        .history-stats {
            display: flex;
            gap: 12px;
            font-size: 0.8em;
            color: var(--text-secondary);
        }

        .empty-history {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .undo-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--accent-primary);
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 600;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
            z-index: 2000;
            box-shadow: var(--shadow-lg);
        }

        .undo-notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .celebration-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.5);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 50px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.5em;
            opacity: 0;
            transition: all 0.3s;
            z-index: 10001;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .celebration-notification.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .celebration-notification i {
            font-size: 1.2em;
            animation: bounce 0.6s infinite alternate;
        }

        @keyframes bounce {
            from {
                transform: translateY(0);
            }
            to {
                transform: translateY(-10px);
            }
        }

        .storage-indicator {
            margin-top: 30px;
            padding: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .storage-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .storage-header h3 {
            font-size: 1.1em;
            color: var(--text-primary);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .storage-header h3 i {
            color: var(--accent-primary);
        }

        .storage-header p {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .donut-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .donut {
            position: relative;
            width: 120px;
            height: 120px;
        }

        .donut-ring {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(
                var(--accent-primary) 0% var(--usage-percent),
                var(--border-color) var(--usage-percent) 100%
            );
        }

        .donut-hole {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .donut-percent {
            font-size: 1.4em;
            font-weight: bold;
            color: var(--accent-primary);
        }

        .donut-label {
            font-size: 0.7em;
            color: var(--text-secondary);
        }

        .storage-details {
            display: flex;
            justify-content: space-around;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .storage-detail {
            text-align: center;
        }

        .storage-detail-value {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9em;
        }

        .storage-detail-label {
            font-size: 0.75em;
            color: var(--text-secondary);
            margin-top: 3px;
        }

        .count-size {
            font-size: 0.75em;
            color: var(--text-secondary);
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .count-size i {
            color: var(--accent-primary);
        }

        .count-size-mb {
            font-weight: 600;
            color: var(--accent-primary);
        }

        .count-progress {
            margin-top: 12px;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            overflow: hidden;
        }

        .count-progress-fill {
            height: 100%;
            background: var(--accent-primary);
            transition: width 0.3s;
        }

        .hidden {
            display: none;
        }

        /* Info Accordion styles */
        .info-accordion {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .info-accordion-header {
            padding: 15px 20px;
            background: var(--bg-tertiary);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .info-accordion-header:hover {
            background: var(--border-color);
        }

        .info-accordion-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1em;
        }

        .info-accordion-title i {
            color: var(--accent-primary);
            font-size: 1.1em;
        }

        .info-accordion-icon {
            color: var(--text-secondary);
            transition: transform 0.3s;
        }

        .info-accordion.open .info-accordion-icon {
            transform: rotate(180deg);
        }

        .info-accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .info-accordion.open .info-accordion-content {
            max-height: 1000px;
        }

        .info-section {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .info-section:last-child {
            border-bottom: none;
        }

        .info-section h4 {
            color: var(--text-primary);
            font-size: 1.05em;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-section h4 i {
            color: var(--accent-primary);
        }

        .info-section p,
        .info-section li {
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 0.9em;
        }

        .info-section ol,
        .info-section ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .info-section li {
            margin-bottom: 8px;
        }

        .info-section strong {
            color: var(--accent-primary);
            font-weight: 600;
        }

        /* Dashboard redesign styles */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .dashboard-header h2 {
            font-size: 1.8em;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .dashboard-header h2 i {
            color: var(--accent-primary);
        }

        .dashboard-subtitle {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-top: 5px;
        }

        .dashboard-stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--accent-primary);
        }

        .stat-card-icon {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-hover));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: white;
        }

        .stat-card-content {
            flex: 1;
        }

        .stat-card-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--text-primary);
            line-height: 1;
        }

        .stat-card-label {
            color: var(--text-secondary);
            font-size: 0.85em;
            margin-top: 5px;
            font-weight: 500;
        }

        .storage-legend {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 6px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .legend-item:last-child {
            border-bottom: none;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .legend-name {
            flex: 1;
            font-size: 0.85em;
            color: var(--text-primary);
            font-weight: 500;
        }

        .legend-size {
            font-size: 0.8em;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .counts-section {
            margin-top: 30px;
        }

        .counts-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .counts-section-header h3 {
            font-size: 1.3em;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .counts-section-header h3 i {
            color: var(--accent-primary);
        }

        .view-toggle {
            display: flex;
            gap: 5px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .view-toggle-btn {
            background: transparent;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
            font-size: 1em;
        }

        .view-toggle-btn:hover {
            color: var(--text-primary);
        }

        .view-toggle-btn.active {
            background: var(--accent-primary);
            color: white;
        }

        .counts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .counts-table {
            display: block;
        }

        .counts-table-wrapper {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .counts-table-inner {
            width: 100%;
            border-collapse: collapse;
        }

        .counts-table-inner th {
            background: var(--bg-tertiary);
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            font-size: 0.85em;
            color: var(--text-primary);
        }

        .counts-table-inner td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9em;
            color: var(--text-primary);
        }

        .counts-table-inner tr:last-child td {
            border-bottom: none;
        }

        .counts-table-inner tbody tr {
            transition: background 0.2s;
        }

        .counts-table-inner tbody tr:hover {
            background: var(--bg-tertiary);
        }

        .table-count-name {
            font-weight: 600;
            color: var(--accent-primary);
        }

        .table-progress-bar {
            width: 100%;
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
        }

        .table-progress-fill {
            height: 100%;
            background: var(--accent-primary);
            transition: width 0.3s;
        }

        @media (max-width: 767px) {
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .dashboard-header .btn {
                width: 100%;
            }

            .dashboard-stats-row {
                grid-template-columns: 1fr;
            }

            .counts-section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .view-toggle {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-logo-title">
                    <svg class="app-logo" width="40" height="40" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
                        <path fill="currentColor" d="M256 29c-8 0-15.6 4.345-21.73 12.719C228.139 50.092 224 62.317 224 76s4.139 25.908 10.27 34.281C240.4 118.655 248 123 256 123s15.6-4.345 21.73-12.719C283.861 101.908 288 89.683 288 76s-4.139-25.908-10.27-34.281C271.6 33.345 264 29 256 29zm-95.193 17.709c5.36 11.73 10.839 23.721 17.06 34.92 9.615 17.307 20.842 31.662 34.158 38.32l11.79 5.895a56.89 56.89 0 0 1-4.069-4.93C211.038 109.02 206 93.244 206 76c0-5.837.59-11.5 1.691-16.906-14.322-2.912-29.655-7.03-46.884-12.385zm190.386 0c-17.229 5.355-32.562 9.473-46.884 12.385A84.694 84.694 0 0 1 306 76c0 17.245-5.038 33.02-13.746 44.914a56.89 56.89 0 0 1-4.068 4.93l11.789-5.895c13.316-6.658 24.543-21.013 34.158-38.32 6.221-11.199 11.7-23.19 17.06-34.92zm-124.523 82.02l-14.645 7.322c-17.61 8.805-37.942 12.78-52.865 18.377-7.461 2.798-13.401 5.966-16.96 9.347-3.56 3.382-5.2 6.475-5.2 12.225 0 37.6 15.54 83.15 29.61 129.379 14.069 46.228 26.816 93.388 18.216 136.387l-.238 1.181-.537 1.078c-8.94 17.879-22.705 29.286-37.586 37.79-3.661 2.091-7.398 4.026-11.178 5.878 23.968-.33 48.317-4.023 66.35-22.056L208 459.27l6.363 6.366c8 8 15.805 15.74 23.037 21.164 3.413 2.56 6.625 4.506 9.6 5.873V244c0-1-1.397-6.713-4.414-13.21-3.017-6.498-7.362-14.25-12.219-22.02-9.714-15.543-21.79-31.467-28.73-38.407l-8.83-8.828 11.168-5.586c14.926-7.463 21.56-14.477 24.537-18.941 1.488-2.232 2.083-3.851 2.334-4.73.011-.041.006-.01.015-.044a51.013 51.013 0 0 1-4.191-3.506zm58.66 0a51.013 51.013 0 0 1-4.191 3.505c.01.035.004.003.015.043.251.88.846 2.499 2.334 4.73 2.976 4.465 9.61 11.479 24.537 18.942l11.168 5.586-8.83 8.828c-6.94 6.94-19.016 22.864-28.73 38.407-4.857 7.77-9.204 15.522-12.22 22.02C266.394 237.286 265 243 265 244v248.674c2.975-1.367 6.187-3.313 9.6-5.873 7.232-5.424 15.037-13.164 23.037-21.164L304 459.27l6.363 6.366c18.033 18.033 42.382 21.726 66.35 22.056-3.78-1.852-7.517-3.787-11.178-5.879-14.881-8.503-28.647-19.91-37.586-37.789l-.537-1.078-.238-1.181c-8.6-42.999 4.147-90.159 18.217-136.387C359.46 259.15 375 213.6 375 176c0-5.75-1.64-8.843-5.2-12.225-3.559-3.381-9.499-6.55-16.96-9.347-14.923-5.596-35.255-9.572-52.865-18.377zM246.736 141a37.331 37.331 0 0 1-3.248 5.992c-3.909 5.864-10.58 12.602-21.33 19.326 7.528 9.042 15.934 20.847 23.475 32.912.47.752.911 1.496 1.367 2.245V141zM265 141v60.475c.456-.749.898-1.493 1.367-2.245 7.541-12.065 15.947-23.87 23.475-32.912-10.75-6.724-17.421-13.462-21.33-19.326a37.331 37.331 0 0 1-3.248-5.992z"/>
                    </svg>
                    <div>
                        <h1>The Count</h1>
                        <p>Manage your inventory counts</p>
                    </div>
                </div>
                <button class="theme-toggle" onclick="toggleDarkMode()" id="theme-toggle" aria-label="Toggle dark mode">
                    <span class="theme-icon">ðŸŒ™</span>
                </button>
            </div>
        </div>

        <div class="content">
            <div id="dashboard-view">
                <div class="info-accordion">
                    <div class="info-accordion-header" onclick="toggleInfoAccordion()">
                        <div class="info-accordion-title">
                            <i class="fas fa-info-circle"></i>
                            <span>About The Count & How to Use</span>
                        </div>
                        <i class="fas fa-chevron-down info-accordion-icon" id="info-accordion-icon"></i>
                    </div>
                    <div class="info-accordion-content" id="info-accordion-content">
                        <div class="info-section">
                            <h4><i class="fas fa-clipboard-check"></i> What is The Count?</h4>
                            <p>The Count is a powerful inventory counting tool designed to help you manage and track stock counts efficiently. Upload XML files containing your inventory items, count them in real-time, and export the results for further processing.</p>
                        </div>
                        <div class="info-section">
                            <h4><i class="fas fa-rocket"></i> Getting Started</h4>
                            <ol>
                                <li><strong>Create a Count:</strong> Click "Create New Count" and give your count a name</li>
                                <li><strong>Upload XML Files:</strong> Select one or more XML files containing your inventory items</li>
                                <li><strong>Start Counting:</strong> Click on a count to open it and begin counting items</li>
                                <li><strong>Track Progress:</strong> Use the statistics at the top to monitor your progress</li>
                                <li><strong>Export Results:</strong> When finished, export your count as a CSV file</li>
                            </ol>
                        </div>
                        <div class="info-section">
                            <h4><i class="fas fa-keyboard"></i> Features</h4>
                            <ul>
                                <li><strong>Counter Controls:</strong> Use +/- buttons for single increments, or +x/-x for custom amounts</li>
                                <li><strong>Mark as Done:</strong> Check items off as you complete them</li>
                                <li><strong>Search & Filter:</strong> Quickly find items by PosID or name</li>
                                <li><strong>Undo/Redo:</strong> Made a mistake? Use Ctrl+Z to undo (Ctrl+Shift+Z or Ctrl+Y to redo)</li>
                                <li><strong>History:</strong> View and restore previous states of your count</li>
                                <li><strong>IndexedDB Storage:</strong> Store large amounts of data locally (50MB+ capacity)</li>
                                <li><strong>Dark Mode:</strong> Toggle between light and dark themes using the button in the header</li>
                            </ul>
                        </div>
                        <div class="info-section">
                            <h4><i class="fas fa-lightbulb"></i> Tips</h4>
                            <ul>
                                <li>Mark items as "done" as you complete them to track progress accurately</li>
                                <li>Use the search box to quickly locate specific items</li>
                                <li>Export your counts regularly as backups</li>
                                <li>On mobile devices, the interface automatically adapts to an accordion view for easier use</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="dashboard-header">
                    <div>
                        <h2><i class="fas fa-chart-line"></i> Dashboard Overview</h2>
                        <p class="dashboard-subtitle">Manage and track your inventory counts</p>
                    </div>
                    <div class="button-group">
                        <button class="btn" onclick="showCreateView()"><i class="fas fa-plus"></i> Create New Count</button>
                        <button class="btn btn-secondary" onclick="downloadBackup()"><i class="fas fa-download"></i> Download Backup</button>
                        <button class="btn btn-secondary" onclick="showUploadBackupModal()"><i class="fas fa-upload"></i> Upload Backup</button>
                    </div>
                </div>

                <div class="dashboard-stats-row">
                    <div class="stat-card">
                        <div class="stat-card-icon"><i class="fas fa-clipboard-list"></i></div>
                        <div class="stat-card-content">
                            <div class="stat-card-value" id="total-counts">0</div>
                            <div class="stat-card-label">Total Counts</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon"><i class="fas fa-check-double"></i></div>
                        <div class="stat-card-content">
                            <div class="stat-card-value" id="completed-counts">0</div>
                            <div class="stat-card-label">Completed Counts</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon"><i class="fas fa-hourglass-start"></i></div>
                        <div class="stat-card-content">
                            <div class="stat-card-value" id="unstarted-counts">0</div>
                            <div class="stat-card-label">Unstarted Counts</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon"><i class="fas fa-database"></i></div>
                        <div class="stat-card-content">
                            <div class="stat-card-value" id="total-storage">0 MB</div>
                            <div class="stat-card-label">Storage Used</div>
                        </div>
                    </div>
                </div>

                <div class="counts-section">
                    <div class="counts-section-header">
                        <h3><i class="fas fa-folder-open"></i> My Counts</h3>
                        <div class="view-toggle">
                            <button class="view-toggle-btn" data-view="grid" onclick="switchCountView('grid')">
                                <i class="fas fa-th"></i>
                            </button>
                            <button class="view-toggle-btn active" data-view="table" onclick="switchCountView('table')">
                                <i class="fas fa-table"></i>
                            </button>
                        </div>
                    </div>
                    <div id="counts-list" class="counts-list counts-table"></div>
                </div>
            </div>

            <div id="create-view" class="hidden">
                <button class="btn btn-secondary back-btn" onclick="showDashboard()"><i class="fas fa-arrow-left"></i> Back to Dashboard</button>
                <h2><i class="fas fa-file-plus"></i> Create New Count</h2>
                <div class="form-group">
                    <label for="count-name">Count Name</label>
                    <input type="text" id="count-name" placeholder="Enter count name...">
                </div>
                <div class="form-group">
                    <label>Upload XML Files</label>
                    <div class="file-upload" onclick="document.getElementById('xml-files').click()">
                        <input type="file" id="xml-files" accept=".xml" multiple onchange="handleFileUpload(event)">
                        <p>Click to select XML files or drag and drop</p>
                        <p style="color: #6c757d; margin-top: 10px; font-size: 0.9em;">You can select multiple files at once</p>
                    </div>
                    <div id="file-list" style="margin-top: 15px;"></div>
                </div>
                <button class="btn" onclick="createCount()"><i class="fas fa-check"></i> Create Count</button>
            </div>

            <div id="count-view" class="hidden">
                <button class="btn btn-secondary back-btn" onclick="showDashboard()"><i class="fas fa-arrow-left"></i> Back to Dashboard</button>
                <div id="count-header"></div>
                <div class="stats">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <i class="fas fa-clipboard-list stat-icon"></i>
                            <div class="stat-value" id="total-items">0</div>
                            <div class="stat-label">Total Items</div>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-check-circle stat-icon"></i>
                            <div class="stat-value" id="completed-items">0</div>
                            <div class="stat-label">Completed</div>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-circle-notch stat-icon"></i>
                            <div class="stat-value" id="incomplete-items">0</div>
                            <div class="stat-label">In Progress</div>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-circle-check stat-icon"></i>
                            <div class="stat-value" id="empty-completed">0</div>
                            <div class="stat-label">Done (Empty)</div>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-boxes-stacked stat-icon"></i>
                            <div class="stat-value" id="items-with-counts">0</div>
                            <div class="stat-label">Has Counts</div>
                        </div>
                    </div>
                </div>
                <div class="search-box">
                    <input type="text" id="search-items" placeholder="Search by PosID or Item Name..." oninput="filterItems()">
                    <div class="filter-checkbox">
                        <input type="checkbox" id="show-only-done" onchange="toggleShowOnlyDone()">
                        <label for="show-only-done">Only show done</label>
                    </div>
                </div>
                <div class="button-group" style="margin-bottom: 20px;">
                    <button class="btn btn-small" onclick="undo()" id="undo-btn"><i class="fas fa-undo"></i> Undo</button>
                    <button class="btn btn-small" onclick="redo()" id="redo-btn"><i class="fas fa-redo"></i> Redo</button>
                    <button class="btn btn-small btn-secondary" onclick="showHistoryModal()"><i class="fas fa-clock-rotate-left"></i> History</button>
                    <button class="btn btn-small btn-secondary" onclick="exportCount()"><i class="fas fa-download"></i> Export</button>
                    <button class="btn btn-small btn-danger" onclick="deleteCurrentCount()"><i class="fas fa-trash"></i> Delete</button>
                </div>
                <div class="table-wrapper">
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th>PosID</th>
                                <th>Item Name</th>
                                <th>Cases</th>
                                <th>Inners</th>
                                <th>Individuals</th>
                                <th class="checkbox-cell">Done</th>
                            </tr>
                        </thead>
                        <tbody id="items-tbody"></tbody>
                    </table>
                </div>
                <div class="items-accordion" id="items-accordion"></div>
            </div>
        </div>
    </div>

    <div id="custom-value-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Enter Value</h3>
                <p id="modal-description"></p>
            </div>
            <input type="number" id="modal-input" class="modal-input" placeholder="Enter amount..." min="1">
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn" onclick="applyCustomValue()">Apply</button>
            </div>
        </div>
    </div>

    <div id="history-modal" class="modal">
        <div class="modal-content history-modal-content">
            <div class="modal-header">
                <h3>History</h3>
                <p>Click on any point in time to restore</p>
            </div>
            <div id="history-list" class="history-list"></div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeHistoryModal()">Close</button>
            </div>
        </div>
    </div>

    <div id="upload-backup-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-upload"></i> Upload Backup</h3>
                <p>Restore your counts from a backup file</p>
            </div>
            <div class="file-upload" onclick="document.getElementById('backup-file-input').click()" style="margin-bottom: 20px;">
                <input type="file" id="backup-file-input" accept=".json" onchange="handleBackupFileSelect(event)" style="display: none;">
                <p><i class="fas fa-file-upload" style="font-size: 2em; margin-bottom: 10px; color: var(--accent-primary);"></i></p>
                <p>Click to select a backup file (.json)</p>
            </div>
            <div id="backup-file-info" style="margin-bottom: 20px; display: none;">
                <p style="color: var(--text-primary); font-weight: 600; margin-bottom: 10px;">Selected file:</p>
                <p id="backup-file-name" style="color: var(--text-secondary); font-size: 0.9em;"></p>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeUploadBackupModal()">Cancel</button>
                <button class="btn" id="restore-backup-btn" onclick="restoreBackup()" disabled>Restore Backup</button>
            </div>
        </div>
    </div>

    <div id="delete-count-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i> Delete Count</h3>
                <p>Are you sure you want to delete this count?</p>
            </div>
            <div style="padding: 20px; background: var(--bg-tertiary); border-radius: 6px; margin-bottom: 20px;">
                <p style="color: var(--text-primary); font-weight: 600; margin-bottom: 5px;" id="delete-count-name"></p>
                <p style="color: var(--text-secondary); font-size: 0.85em;">This action cannot be undone.</p>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeDeleteCountModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDeleteCount()">Delete Count</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Dexie IndexedDB
        const db = new Dexie('TheCountDB');
        db.version(1).stores({
            counts: 'id, name, createdAt',
            settings: 'key'
        });

        let counts = {};
        let currentCountId = null;
        let uploadedFiles = [];
        let currentFilter = '';
        let activeAccordionIndex = null;
        let modalContext = null;
        let showOnlyDone = false;
        let searchDebounce = null;
        let currentCountView = 'table'; // 'grid' or 'table'
        let history = {
            past: [],
            future: [],
            maxSize: 50
        };

        async function migrateFromLocalStorage() {
            try {
                // Check if there's data in localStorage that needs migrating
                const localStorageCounts = localStorage.getItem('counts');
                if (localStorageCounts) {
                    const parsedCounts = JSON.parse(localStorageCounts);

                    // Migrate each count to IndexedDB
                    for (const countId in parsedCounts) {
                        await db.counts.put({ ...parsedCounts[countId], id: countId });
                    }

                    console.log('Migrated data from localStorage to IndexedDB');
                    // Optionally remove from localStorage after migration
                    localStorage.removeItem('counts');
                }

                // Migrate theme setting
                const localStorageTheme = localStorage.getItem('theme');
                if (localStorageTheme) {
                    await db.settings.put({ key: 'theme', value: localStorageTheme });
                    localStorage.removeItem('theme');
                }
            } catch (error) {
                console.error('Error migrating from localStorage:', error);
            }
        }

        async function loadCounts() {
            try {
                const allCounts = await db.counts.toArray();
                counts = {};
                allCounts.forEach(count => {
                    counts[count.id] = count;
                    // Add completed property to existing items for backwards compatibility
                    count.items.forEach(item => {
                        if (item.completed === undefined) {
                            item.completed = false;
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading counts from IndexedDB:', error);
            }
        }

        async function toggleDarkMode() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            html.setAttribute('data-theme', newTheme);
            await db.settings.put({ key: 'theme', value: newTheme });

            // Update icon
            const icon = document.querySelector('.theme-icon');
            icon.textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
        }

        async function loadTheme() {
            try {
                const themeSetting = await db.settings.get('theme');
                const savedTheme = themeSetting ? themeSetting.value : 'light';
                document.documentElement.setAttribute('data-theme', savedTheme);

                const icon = document.querySelector('.theme-icon');
                if (icon) {
                    icon.textContent = savedTheme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
                }
            } catch (error) {
                console.error('Error loading theme:', error);
                document.documentElement.setAttribute('data-theme', 'light');
            }
        }

        // Storage management functions
        async function getStorageSize() {
            try {
                // Calculate size based on our actual data (counts + settings)
                let total = 0;
                const allCounts = await db.counts.toArray();
                allCounts.forEach(count => {
                    total += JSON.stringify(count).length * 2;
                });
                const allSettings = await db.settings.toArray();
                allSettings.forEach(setting => {
                    total += JSON.stringify(setting).length * 2;
                });
                return total;
            } catch (error) {
                console.error('Error calculating storage size:', error);
                return 0;
            }
        }

        function getCountSize(countId) {
            const count = counts[countId];
            if (!count) return 0;

            const countJson = JSON.stringify(count);
            return countJson.length * 2; // UTF-16 encoding estimate
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function updateStorageIndicator() {
            // Removed - no longer needed without donut chart
        }

        async function saveCounts() {
            try {
                // Save all counts to IndexedDB
                const savePromises = Object.keys(counts).map(countId => {
                    return db.counts.put({ ...counts[countId], id: countId });
                });
                await Promise.all(savePromises);
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    handleStorageQuotaExceeded();
                } else {
                    console.error('Failed to save counts:', e);
                    alert('Failed to save data. Please export your counts as a backup.');
                }
            }
        }

        function handleStorageQuotaExceeded() {
            const message = 'Storage limit reached! Your data will be automatically exported as a backup. Please delete old counts to free up space.';
            alert(message);

            // Automatically export all data as backup
            exportAllData();

            // Show list of counts to delete
            showDashboard();
        }

        function exportAllData() {
            const data = {
                counts: counts,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };

            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `the-count-backup-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function downloadBackup() {
            exportAllData();
        }

        let selectedBackupFile = null;

        function showUploadBackupModal() {
            document.getElementById('upload-backup-modal').classList.add('show');
            selectedBackupFile = null;
            document.getElementById('backup-file-input').value = '';
            document.getElementById('backup-file-info').style.display = 'none';
            document.getElementById('restore-backup-btn').disabled = true;
        }

        function closeUploadBackupModal() {
            document.getElementById('upload-backup-modal').classList.remove('show');
            selectedBackupFile = null;
        }

        function handleBackupFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            selectedBackupFile = file;
            document.getElementById('backup-file-name').textContent = file.name;
            document.getElementById('backup-file-info').style.display = 'block';
            document.getElementById('restore-backup-btn').disabled = false;
        }

        async function restoreBackup() {
            if (!selectedBackupFile) return;

            try {
                const text = await selectedBackupFile.text();
                const data = JSON.parse(text);

                if (!data.counts || typeof data.counts !== 'object') {
                    alert('Invalid backup file format.');
                    return;
                }

                // Confirm with user
                const countKeys = Object.keys(data.counts);
                const message = `This will restore ${countKeys.length} count(s) from the backup.\n\nExisting counts with the same IDs will be overwritten.\n\nContinue?`;

                if (!confirm(message)) {
                    return;
                }

                // Restore counts to memory
                Object.assign(counts, data.counts);

                // Save to IndexedDB
                await saveCounts();

                // Close modal and refresh
                closeUploadBackupModal();
                await renderCountsList();

                alert('Backup restored successfully!');
            } catch (error) {
                console.error('Error restoring backup:', error);
                alert('Failed to restore backup. Please check the file format.');
            }
        }

        let countToDelete = null;

        function showDeleteCountModal(countId, event) {
            if (event) {
                event.stopPropagation();
            }

            countToDelete = countId;
            const count = counts[countId];

            document.getElementById('delete-count-name').textContent = count.name;
            document.getElementById('delete-count-modal').classList.add('show');
        }

        function closeDeleteCountModal() {
            document.getElementById('delete-count-modal').classList.remove('show');
            countToDelete = null;
        }

        async function confirmDeleteCount() {
            if (!countToDelete) return;

            await db.counts.delete(countToDelete);
            delete counts[countToDelete];

            closeDeleteCountModal();
            await renderCountsList();
        }

        function exportCountFromDashboard(countId, event) {
            if (event) {
                event.stopPropagation();
            }

            const count = counts[countId];
            if (!count) return;

            let csv = 'PosID,Item Name,Cases,Inners,Individuals,Completed\n';
            count.items.forEach(item => {
                csv += `${item.posId},"${item.itemName}",${item.cases},${item.inners},${item.individuals},${item.completed ? 'Yes' : 'No'}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${count.name.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // History management
        function recordHistory() {
            if (!currentCountId) return;

            const snapshot = {
                countId: currentCountId,
                state: JSON.parse(JSON.stringify(counts[currentCountId])),
                timestamp: Date.now()
            };

            history.past.push(snapshot);
            history.future = [];

            // Limit history size
            if (history.past.length > history.maxSize) {
                history.past.shift();
            }
        }

        async function undo() {
            if (history.past.length === 0) return;

            const current = {
                countId: currentCountId,
                state: JSON.parse(JSON.stringify(counts[currentCountId])),
                timestamp: Date.now()
            };

            history.future.push(current);

            const previous = history.past.pop();
            counts[previous.countId] = JSON.parse(JSON.stringify(previous.state));

            await saveCounts();
            renderItems();
            updateStats();
            checkAndCelebrate();

            showUndoNotification('Undo');
        }

        async function redo() {
            if (history.future.length === 0) return;

            const current = {
                countId: currentCountId,
                state: JSON.parse(JSON.stringify(counts[currentCountId])),
                timestamp: Date.now()
            };

            history.past.push(current);

            const next = history.future.pop();
            counts[next.countId] = JSON.parse(JSON.stringify(next.state));

            await saveCounts();
            renderItems();
            updateStats();
            checkAndCelebrate();

            showUndoNotification('Redo');
        }

        function showUndoNotification(action) {
            const notification = document.createElement('div');
            notification.className = 'undo-notification';
            notification.textContent = action;
            document.body.appendChild(notification);

            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 1500);
        }

        function showHistoryModal() {
            document.getElementById('history-modal').classList.add('show');
            renderHistoryList();
        }

        function closeHistoryModal() {
            document.getElementById('history-modal').classList.remove('show');
        }

        function renderHistoryList() {
            const listEl = document.getElementById('history-list');

            if (history.past.length === 0) {
                listEl.innerHTML = '<div class="empty-history">No history available</div>';
                return;
            }

            listEl.innerHTML = history.past.slice().reverse().map((snapshot, index) => {
                const actualIndex = history.past.length - 1 - index;
                const date = new Date(snapshot.timestamp);
                const timeStr = date.toLocaleTimeString();

                const completedCount = snapshot.state.items.filter(i => i.completed).length;
                const totalItems = snapshot.state.items.length;

                let totalCases = 0, totalInners = 0, totalIndividuals = 0;
                snapshot.state.items.forEach(item => {
                    totalCases += item.cases;
                    totalInners += item.inners;
                    totalIndividuals += item.individuals;
                });

                return `
                    <div class="history-item" onclick="restoreFromHistory(${actualIndex})">
                        <div class="history-time">${timeStr}</div>
                        <div class="history-stats">
                            <span>${completedCount}/${totalItems} done</span>
                            <span>Cases: ${totalCases}</span>
                            <span>Inners: ${totalInners}</span>
                            <span>Indiv: ${totalIndividuals}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function restoreFromHistory(index) {
            if (!history.past[index]) return;

            // Save current state to future
            const current = {
                countId: currentCountId,
                state: JSON.parse(JSON.stringify(counts[currentCountId])),
                timestamp: Date.now()
            };

            // Remove all history after this point and add to future
            const removed = history.past.splice(index + 1);
            history.future = removed.reverse().concat(history.future);

            // Restore the selected state
            const snapshot = history.past[index];
            counts[snapshot.countId] = JSON.parse(JSON.stringify(snapshot.state));

            await saveCounts();
            renderItems();
            updateStats();
            checkAndCelebrate();
            closeHistoryModal();

            showUndoNotification('Restored');
        }

        function generateId() {
            return 'count_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function toggleInfoAccordion() {
            const accordion = document.querySelector('.info-accordion');
            accordion.classList.toggle('open');
        }

        function switchCountView(view) {
            currentCountView = view;

            // Update button states
            document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });

            // Re-render the counts list
            renderCountsList();
        }

        async function showDashboard() {
            document.getElementById('dashboard-view').classList.remove('hidden');
            document.getElementById('create-view').classList.add('hidden');
            document.getElementById('count-view').classList.add('hidden');
            currentCountId = null;
            await renderCountsList();
        }

        function showCreateView() {
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('create-view').classList.remove('hidden');
            document.getElementById('count-view').classList.add('hidden');
            document.getElementById('count-name').value = '';
            document.getElementById('xml-files').value = '';
            document.getElementById('file-list').innerHTML = '';
            uploadedFiles = [];
        }

        function showCountView(countId) {
            currentCountId = countId;
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('create-view').classList.add('hidden');
            document.getElementById('count-view').classList.remove('hidden');
            document.getElementById('search-items').value = '';
            currentFilter = '';
            activeAccordionIndex = null;
            renderCountView();
        }

        async function renderCountsList() {
            const listEl = document.getElementById('counts-list');
            const countIds = Object.keys(counts);

            // Update dashboard stats
            await updateDashboardStats();

            if (countIds.length === 0) {
                listEl.className = 'counts-list counts-grid';
                listEl.innerHTML = '<div class="empty-state"><i class="fas fa-inbox" style="font-size: 3em; color: var(--text-secondary); margin-bottom: 15px;"></i><h2>No counts yet</h2><p>Create your first count to get started</p></div>';
                return;
            }

            const totalSize = await getStorageSize();

            if (currentCountView === 'grid') {
                listEl.className = 'counts-list counts-grid';
                listEl.innerHTML = countIds.map(id => {
                    const count = counts[id];
                    const date = new Date(count.createdAt).toLocaleDateString();
                    const countSize = getCountSize(id);
                    const sizePercent = totalSize > 0 ? Math.round((countSize / totalSize) * 100) : 0;

                    const completedCount = count.items.filter(i => i.completed).length;
                    const completionPercent = count.items.length > 0 ? Math.round((completedCount / count.items.length) * 100) : 0;

                    return `
                        <div class="count-card">
                            <div onclick="showCountView('${id}')" style="cursor: pointer;">
                                <h3><i class="fas fa-clipboard-list"></i> ${escapeHtml(count.name)}</h3>
                                <p><i class="fas fa-boxes"></i> ${count.items.length} items</p>
                                <p><i class="fas fa-check-circle"></i> ${completedCount} completed (${completionPercent}%)</p>
                                <div class="count-progress">
                                    <div class="count-progress-fill" style="width: ${completionPercent}%"></div>
                                </div>
                                <p style="margin-top: 10px;"><i class="fas fa-calendar"></i> ${date}</p>
                                <div class="count-size">
                                    <i class="fas fa-database"></i>
                                    <span class="count-size-mb">${formatBytes(countSize)}</span>
                                    <span>(${sizePercent}%)</span>
                                </div>
                            </div>
                            <div class="count-card-actions">
                                <button class="btn btn-small btn-secondary" onclick="exportCountFromDashboard('${id}', event)" title="Export Count">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn btn-small btn-danger" onclick="showDeleteCountModal('${id}', event)" title="Delete Count">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                // Table view
                listEl.className = 'counts-list counts-table';
                const tableRows = countIds.map(id => {
                    const count = counts[id];
                    const date = new Date(count.createdAt).toLocaleDateString();
                    const countSize = getCountSize(id);

                    const completedCount = count.items.filter(i => i.completed).length;
                    const completionPercent = count.items.length > 0 ? Math.round((completedCount / count.items.length) * 100) : 0;

                    return `
                        <tr>
                            <td onclick="showCountView('${id}')" style="cursor: pointer;"><span class="table-count-name">${escapeHtml(count.name)}</span></td>
                            <td onclick="showCountView('${id}')" style="cursor: pointer;">${count.items.length}</td>
                            <td onclick="showCountView('${id}')" style="cursor: pointer;">
                                <div>${completedCount} / ${count.items.length}</div>
                                <div class="table-progress-bar">
                                    <div class="table-progress-fill" style="width: ${completionPercent}%"></div>
                                </div>
                            </td>
                            <td onclick="showCountView('${id}')" style="cursor: pointer;">${formatBytes(countSize)}</td>
                            <td onclick="showCountView('${id}')" style="cursor: pointer;">${date}</td>
                            <td class="table-actions">
                                <button class="btn btn-small btn-secondary" onclick="exportCountFromDashboard('${id}', event)" title="Export Count">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn btn-small btn-danger" onclick="showDeleteCountModal('${id}', event)" title="Delete Count">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

                listEl.innerHTML = `
                    <div class="counts-table-wrapper">
                        <table class="counts-table-inner">
                            <thead>
                                <tr>
                                    <th>Count Name</th>
                                    <th>Items</th>
                                    <th>Progress</th>
                                    <th>Size</th>
                                    <th>Created</th>
                                    <th class="table-actions-header">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                `;
            }
        }

        async function updateDashboardStats() {
            const countIds = Object.keys(counts);
            let completedCounts = 0;
            let unstartedCounts = 0;

            countIds.forEach(id => {
                const count = counts[id];
                const totalItems = count.items.length;
                const completedItems = count.items.filter(i => i.completed).length;

                // Count is completed if all items are marked as completed
                if (totalItems > 0 && completedItems === totalItems) {
                    completedCounts++;
                }

                // Count is unstarted if no items have been completed
                if (completedItems === 0) {
                    unstartedCounts++;
                }
            });

            // Calculate total storage used
            const totalStorage = await getStorageSize();

            document.getElementById('total-counts').textContent = countIds.length;
            document.getElementById('completed-counts').textContent = completedCounts;
            document.getElementById('unstarted-counts').textContent = unstartedCounts;
            document.getElementById('total-storage').textContent = formatBytes(totalStorage);
        }

        function handleFileUpload(event) {
            uploadedFiles = Array.from(event.target.files);
            const fileListEl = document.getElementById('file-list');

            if (uploadedFiles.length === 0) {
                fileListEl.innerHTML = '';
                return;
            }

            fileListEl.innerHTML = `
                <p style="color: #333; font-weight: 600;">Selected files:</p>
                <ul style="margin-top: 10px; padding-left: 20px;">
                    ${uploadedFiles.map(f => `<li>${escapeHtml(f.name)}</li>`).join('')}
                </ul>
            `;
        }

        async function createCount() {
            const name = document.getElementById('count-name').value.trim();

            if (!name) {
                alert('Please enter a count name');
                return;
            }

            if (uploadedFiles.length === 0) {
                alert('Please upload at least one XML file');
                return;
            }

            try {
                const items = await parseXMLFiles(uploadedFiles);

                const countId = generateId();
                counts[countId] = {
                    name: name,
                    createdAt: new Date().toISOString(),
                    items: items
                };

                await saveCounts();
                showCountView(countId);
            } catch (error) {
                alert('Error creating count: ' + error.message);
            }
        }

        async function parseXMLFiles(files) {
            const itemsMap = new Map();

            for (const file of files) {
                const text = await file.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(text, 'text/xml');

                const items = xmlDoc.getElementsByTagName('CountingListItem');

                for (const item of items) {
                    const posIdEl = item.getElementsByTagName('PosID')[0];
                    const itemNameEl = item.getElementsByTagName('ItemName')[0];

                    if (posIdEl && itemNameEl) {
                        const posId = posIdEl.textContent.trim();
                        const itemName = itemNameEl.textContent.trim();

                        if (!itemsMap.has(posId)) {
                            itemsMap.set(posId, {
                                posId: posId,
                                itemName: itemName,
                                cases: 0,
                                inners: 0,
                                individuals: 0,
                                completed: false
                            });
                        }
                    }
                }
            }

            const itemsArray = Array.from(itemsMap.values());
            itemsArray.sort((a, b) => a.posId.localeCompare(b.posId));
            return itemsArray;
        }

        function renderCountView() {
            const count = counts[currentCountId];
            if (!count) return;

            document.getElementById('count-header').innerHTML = `<h2>${escapeHtml(count.name)}</h2>`;
            renderItems();
            updateStats();
        }

        function renderItems() {
            const count = counts[currentCountId];
            if (!count) return;

            const tbody = document.getElementById('items-tbody');
            const accordion = document.getElementById('items-accordion');
            let items = count.items;

            if (currentFilter) {
                const filter = currentFilter.toLowerCase();
                items = items.filter(item =>
                    item.posId.toLowerCase().includes(filter) ||
                    item.itemName.toLowerCase().includes(filter)
                );
            }

            // Filter by completion status if "only show done" is checked
            if (showOnlyDone) {
                items = items.filter(item => item.completed);
            }

            // Sort items: incomplete first, completed at the bottom
            items = [...items].sort((a, b) => {
                if (a.completed === b.completed) return 0;
                return a.completed ? 1 : -1;
            });

            // Render table view
            tbody.innerHTML = items.map((item, index) => {
                const actualIndex = count.items.indexOf(item);
                const completedClass = item.completed ? 'completed' : '';
                const disabled = item.completed ? 'disabled' : '';
                return `
                    <tr class="${completedClass}" data-item-index="${actualIndex}">
                        <td>${escapeHtml(item.posId)}</td>
                        <td>${escapeHtml(item.itemName)}</td>
                        <td>
                            <div class="counter-controls">
                                <button class="counter-btn-custom" data-action="subtract" data-index="${actualIndex}" data-field="cases" ${disabled}>-x</button>
                                <button class="counter-btn" data-action="decrement" data-index="${actualIndex}" data-field="cases" ${disabled}>-</button>
                                <span class="counter-value" data-field="cases">${item.cases}</span>
                                <button class="counter-btn" data-action="increment" data-index="${actualIndex}" data-field="cases" ${disabled}>+</button>
                                <button class="counter-btn-custom" data-action="add" data-index="${actualIndex}" data-field="cases" ${disabled}>+x</button>
                            </div>
                        </td>
                        <td>
                            <div class="counter-controls">
                                <button class="counter-btn-custom" data-action="subtract" data-index="${actualIndex}" data-field="inners" ${disabled}>-x</button>
                                <button class="counter-btn" data-action="decrement" data-index="${actualIndex}" data-field="inners" ${disabled}>-</button>
                                <span class="counter-value" data-field="inners">${item.inners}</span>
                                <button class="counter-btn" data-action="increment" data-index="${actualIndex}" data-field="inners" ${disabled}>+</button>
                                <button class="counter-btn-custom" data-action="add" data-index="${actualIndex}" data-field="inners" ${disabled}>+x</button>
                            </div>
                        </td>
                        <td>
                            <div class="counter-controls">
                                <button class="counter-btn-custom" data-action="subtract" data-index="${actualIndex}" data-field="individuals" ${disabled}>-x</button>
                                <button class="counter-btn" data-action="decrement" data-index="${actualIndex}" data-field="individuals" ${disabled}>-</button>
                                <span class="counter-value" data-field="individuals">${item.individuals}</span>
                                <button class="counter-btn" data-action="increment" data-index="${actualIndex}" data-field="individuals" ${disabled}>+</button>
                                <button class="counter-btn-custom" data-action="add" data-index="${actualIndex}" data-field="individuals" ${disabled}>+x</button>
                            </div>
                        </td>
                        <td class="checkbox-cell">
                            <input type="checkbox" ${item.completed ? 'checked' : ''} data-action="toggle-complete" data-index="${actualIndex}">
                        </td>
                    </tr>
                `;
            }).join('');

            // Render accordion view
            accordion.innerHTML = items.map((item, index) => {
                const actualIndex = count.items.indexOf(item);
                const completedClass = item.completed ? 'completed' : '';
                const disabled = item.completed ? 'disabled' : '';
                return `
                    <div class="accordion-item ${completedClass}" data-item-index="${actualIndex}">
                        <div class="accordion-header" data-action="toggle-accordion">
                            <div class="accordion-title">
                                <div class="accordion-posid">${escapeHtml(item.posId)}</div>
                                <div class="accordion-itemname">${escapeHtml(item.itemName)}</div>
                            </div>
                            <div class="accordion-indicator">â–¼</div>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-controls">
                                <div class="completed-checkbox">
                                    <input type="checkbox" id="check-${actualIndex}" ${item.completed ? 'checked' : ''} data-action="toggle-complete" data-index="${actualIndex}">
                                    <label for="check-${actualIndex}">Mark as done</label>
                                </div>
                                <div class="control-row">
                                    <span class="control-label">Cases</span>
                                    <div class="counter-controls">
                                        <button class="counter-btn-custom" data-action="subtract" data-index="${actualIndex}" data-field="cases" ${disabled}>-x</button>
                                        <button class="counter-btn" data-action="decrement" data-index="${actualIndex}" data-field="cases" ${disabled}>-</button>
                                        <span class="counter-value" data-field="cases">${item.cases}</span>
                                        <button class="counter-btn" data-action="increment" data-index="${actualIndex}" data-field="cases" ${disabled}>+</button>
                                        <button class="counter-btn-custom" data-action="add" data-index="${actualIndex}" data-field="cases" ${disabled}>+x</button>
                                    </div>
                                </div>
                                <div class="control-row">
                                    <span class="control-label">Inners</span>
                                    <div class="counter-controls">
                                        <button class="counter-btn-custom" data-action="subtract" data-index="${actualIndex}" data-field="inners" ${disabled}>-x</button>
                                        <button class="counter-btn" data-action="decrement" data-index="${actualIndex}" data-field="inners" ${disabled}>-</button>
                                        <span class="counter-value" data-field="inners">${item.inners}</span>
                                        <button class="counter-btn" data-action="increment" data-index="${actualIndex}" data-field="inners" ${disabled}>+</button>
                                        <button class="counter-btn-custom" data-action="add" data-index="${actualIndex}" data-field="inners" ${disabled}>+x</button>
                                    </div>
                                </div>
                                <div class="control-row">
                                    <span class="control-label">Individuals</span>
                                    <div class="counter-controls">
                                        <button class="counter-btn-custom" data-action="subtract" data-index="${actualIndex}" data-field="individuals" ${disabled}>-x</button>
                                        <button class="counter-btn" data-action="decrement" data-index="${actualIndex}" data-field="individuals" ${disabled}>-</button>
                                        <span class="counter-value" data-field="individuals">${item.individuals}</span>
                                        <button class="counter-btn" data-action="increment" data-index="${actualIndex}" data-field="individuals" ${disabled}>+</button>
                                        <button class="counter-btn-custom" data-action="add" data-index="${actualIndex}" data-field="individuals" ${disabled}>+x</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Restore active accordion state
            if (activeAccordionIndex !== null) {
                const accordionItems = document.querySelectorAll('.accordion-item');
                if (accordionItems[activeAccordionIndex]) {
                    accordionItems[activeAccordionIndex].classList.add('active');
                }
            }
        }

        async function changeValue(itemIndex, field, delta) {
            const count = counts[currentCountId];
            const item = count.items[itemIndex];

            if (item.completed) return;

            const oldValue = item[field];
            item[field] = Math.max(0, item[field] + delta);

            // Record for undo/redo
            recordHistory();

            await saveCounts();

            // Partial DOM update instead of full re-render
            updateItemValueInDOM(itemIndex, field, item[field]);
            updateStats();
        }

        function updateItemValueInDOM(itemIndex, field, value) {
            // Update in table view
            const tableRow = document.querySelector(`tr[data-item-index="${itemIndex}"]`);
            if (tableRow) {
                const valueSpan = tableRow.querySelector(`.counter-value[data-field="${field}"]`);
                if (valueSpan) valueSpan.textContent = value;
            }

            // Update in accordion view
            const accordionItem = document.querySelector(`.accordion-item[data-item-index="${itemIndex}"]`);
            if (accordionItem) {
                const valueSpan = accordionItem.querySelector(`.counter-value[data-field="${field}"]`);
                if (valueSpan) valueSpan.textContent = value;
            }
        }

        async function toggleCompleted(itemIndex) {
            const count = counts[currentCountId];
            const item = count.items[itemIndex];

            item.completed = !item.completed;

            recordHistory();
            await saveCounts();
            renderItems();
            updateStats();
            checkAndCelebrate();
        }

        function updateStats() {
            const count = counts[currentCountId];
            if (!count) return;

            const totalItems = count.items.length;
            let completedItems = 0;
            let incompleteItems = 0;
            let emptyCompleted = 0;
            let itemsWithCounts = 0;

            count.items.forEach(item => {
                if (item.completed) {
                    completedItems++;
                    // Check if completed but has no counts
                    if (item.cases === 0 && item.inners === 0 && item.individuals === 0) {
                        emptyCompleted++;
                    }
                } else {
                    incompleteItems++;
                }

                // Has any counts
                if (item.cases > 0 || item.inners > 0 || item.individuals > 0) {
                    itemsWithCounts++;
                }
            });

            document.getElementById('total-items').textContent = totalItems;
            document.getElementById('completed-items').textContent = completedItems;
            document.getElementById('incomplete-items').textContent = incompleteItems;
            document.getElementById('empty-completed').textContent = emptyCompleted;
            document.getElementById('items-with-counts').textContent = itemsWithCounts;
        }

        function filterItems() {
            clearTimeout(searchDebounce);
            searchDebounce = setTimeout(() => {
                currentFilter = document.getElementById('search-items').value;
                activeAccordionIndex = null;
                renderItems();
            }, 300);
        }

        function toggleShowOnlyDone() {
            showOnlyDone = document.getElementById('show-only-done').checked;
            activeAccordionIndex = null;
            renderItems();
        }

        function exportCount() {
            const count = counts[currentCountId];
            if (!count) return;

            let csv = 'PosID,Item Name,Cases,Inners,Individuals\n';
            count.items.forEach(item => {
                csv += `${item.posId},"${item.itemName}",${item.cases},${item.inners},${item.individuals}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${count.name.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function deleteCurrentCount() {
            if (!confirm('Are you sure you want to delete this count? This action cannot be undone.')) {
                return;
            }

            await db.counts.delete(currentCountId);
            delete counts[currentCountId];
            showDashboard();
        }

        function toggleAccordion(header) {
            const accordionItem = header.parentElement;
            const wasActive = accordionItem.classList.contains('active');

            // Get the index of this accordion item
            const allItems = Array.from(document.querySelectorAll('.accordion-item'));
            const itemIndex = allItems.indexOf(accordionItem);

            // Close all accordion items
            document.querySelectorAll('.accordion-item').forEach(item => {
                item.classList.remove('active');
            });

            // Open clicked item if it wasn't active
            if (!wasActive) {
                accordionItem.classList.add('active');
                activeAccordionIndex = itemIndex;
            } else {
                activeAccordionIndex = null;
            }
        }

        function showCustomValueModal(itemIndex, field, operation) {
            const count = counts[currentCountId];
            const item = count.items[itemIndex];

            if (item.completed) return;

            modalContext = { itemIndex, field, operation };

            const fieldName = field.charAt(0).toUpperCase() + field.slice(1);
            document.getElementById('modal-title').textContent = operation === 'add' ? `Add to ${fieldName}` : `Subtract from ${fieldName}`;
            document.getElementById('modal-description').textContent = `${item.posId} - ${item.itemName}`;
            document.getElementById('modal-input').value = '';

            document.getElementById('custom-value-modal').classList.add('show');
            document.getElementById('modal-input').focus();
        }

        function closeModal() {
            document.getElementById('custom-value-modal').classList.remove('show');
            modalContext = null;
        }

        function applyCustomValue() {
            const value = parseInt(document.getElementById('modal-input').value);

            if (isNaN(value) || value < 1) {
                alert('Please enter a valid positive number');
                return;
            }

            const { itemIndex, field, operation } = modalContext;
            const delta = operation === 'add' ? value : -value;

            changeValue(itemIndex, field, delta);
            closeModal();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function checkAndCelebrate() {
            const count = counts[currentCountId];
            if (!count || count.items.length === 0) return;

            // Check if all items are completed
            const allCompleted = count.items.every(item => item.completed);

            if (allCompleted) {
                celebrateCompletion();
            }
        }

        function celebrateCompletion() {
            // Trigger confetti!
            const duration = 3000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 10000 };

            function randomInRange(min, max) {
                return Math.random() * (max - min) + min;
            }

            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();

                if (timeLeft <= 0) {
                    return clearInterval(interval);
                }

                const particleCount = 50 * (timeLeft / duration);

                // Confetti from left
                confetti(Object.assign({}, defaults, {
                    particleCount,
                    origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }
                }));

                // Confetti from right
                confetti(Object.assign({}, defaults, {
                    particleCount,
                    origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }
                }));
            }, 250);

            // Show celebration message
            const notification = document.createElement('div');
            notification.className = 'celebration-notification';
            notification.innerHTML = '<i class="fas fa-trophy"></i> Count Completed! Well done!';
            document.body.appendChild(notification);

            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeHistoryModal();
            }

            // Undo/Redo shortcuts
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'z' && !e.shiftKey) {
                    e.preventDefault();
                    undo();
                } else if ((e.key === 'z' && e.shiftKey) || e.key === 'y') {
                    e.preventDefault();
                    redo();
                }
            }
        });

        // Close modal on background click
        document.getElementById('custom-value-modal').addEventListener('click', (e) => {
            if (e.target.id === 'custom-value-modal') {
                closeModal();
            }
        });

        document.getElementById('upload-backup-modal').addEventListener('click', (e) => {
            if (e.target.id === 'upload-backup-modal') {
                closeUploadBackupModal();
            }
        });

        document.getElementById('delete-count-modal').addEventListener('click', (e) => {
            if (e.target.id === 'delete-count-modal') {
                closeDeleteCountModal();
            }
        });

        // Submit on Enter key
        document.getElementById('modal-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                applyCustomValue();
            }
        });

        // Event delegation for table and accordion
        function setupEventDelegation() {
            // Table wrapper event delegation
            const tableWrapper = document.querySelector('.table-wrapper');
            if (tableWrapper) {
                tableWrapper.addEventListener('click', handleTableClick);
                tableWrapper.addEventListener('change', handleTableChange);
            }

            // Accordion event delegation
            const accordion = document.getElementById('items-accordion');
            if (accordion) {
                accordion.addEventListener('click', handleAccordionClick);
                accordion.addEventListener('change', handleAccordionChange);
            }
        }

        function handleTableClick(e) {
            const target = e.target;
            if (!target.dataset.action) return;

            const action = target.dataset.action;
            const index = parseInt(target.dataset.index);
            const field = target.dataset.field;

            switch (action) {
                case 'increment':
                    changeValue(index, field, 1);
                    break;
                case 'decrement':
                    changeValue(index, field, -1);
                    break;
                case 'add':
                    showCustomValueModal(index, field, 'add');
                    break;
                case 'subtract':
                    showCustomValueModal(index, field, 'subtract');
                    break;
            }
        }

        function handleTableChange(e) {
            const target = e.target;
            if (target.dataset.action === 'toggle-complete') {
                const index = parseInt(target.dataset.index);
                toggleCompleted(index);
            }
        }

        function handleAccordionClick(e) {
            const target = e.target;
            const action = target.dataset.action || target.closest('[data-action]')?.dataset.action;

            if (!action) return;

            if (action === 'toggle-accordion') {
                const header = target.classList.contains('accordion-header') ? target : target.closest('.accordion-header');
                if (header) toggleAccordion(header);
                return;
            }

            const index = parseInt(target.dataset.index);
            const field = target.dataset.field;

            switch (action) {
                case 'increment':
                    changeValue(index, field, 1);
                    break;
                case 'decrement':
                    changeValue(index, field, -1);
                    break;
                case 'add':
                    showCustomValueModal(index, field, 'add');
                    break;
                case 'subtract':
                    showCustomValueModal(index, field, 'subtract');
                    break;
            }
        }

        function handleAccordionChange(e) {
            const target = e.target;
            if (target.dataset.action === 'toggle-complete') {
                const index = parseInt(target.dataset.index);
                toggleCompleted(index);
            }
        }

        // Initialize the app
        (async function initApp() {
            await migrateFromLocalStorage();
            await loadTheme();
            await loadCounts();
            await renderCountsList();
            setupEventDelegation();
        })();
    </script>
</body>
</html>